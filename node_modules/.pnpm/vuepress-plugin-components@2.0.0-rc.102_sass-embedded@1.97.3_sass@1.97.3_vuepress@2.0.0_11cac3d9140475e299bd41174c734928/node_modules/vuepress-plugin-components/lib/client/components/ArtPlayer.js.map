{"version":3,"file":"ArtPlayer.js","sources":["../../../src/client/utils/registerMse.ts","../../../src/client/components/ArtPlayer.ts"],"sourcesContent":["declare const DASHJS_INSTALLED: boolean;\ndeclare const HLS_JS_INSTALLED: boolean;\ndeclare const MPEGTS_JS_INSTALLED: boolean;\n\nexport const SUPPORTED_VIDEO_TYPES = [\"mp4\", \"mp3\", \"webm\", \"ogg\"];\n\nconst isDashjsInstalled =\n  typeof DASHJS_INSTALLED === \"boolean\" && DASHJS_INSTALLED;\nconst isHlsJsInstalled =\n  typeof HLS_JS_INSTALLED === \"boolean\" && HLS_JS_INSTALLED;\nconst isMpegtsJsInstalled =\n  typeof MPEGTS_JS_INSTALLED === \"boolean\" && MPEGTS_JS_INSTALLED;\n\nif (isDashjsInstalled) SUPPORTED_VIDEO_TYPES.push(\"mpd\", \"dash\");\nif (isHlsJsInstalled) SUPPORTED_VIDEO_TYPES.push(\"m3u8\", \"hls\");\n\nif (isMpegtsJsInstalled) SUPPORTED_VIDEO_TYPES.push(\"ts\", \"flv\");\n\nexport const getTypeByUrl = (url: string): string => url.split(\".\").pop() ?? \"\";\n\nexport interface DashOptions {\n  /**\n   * Whether to auto play after initialization\n   *\n   * @default false\n   */\n  autoPlay?: boolean;\n\n  /**\n   * Starting time in seconds\n   *\n   * @default 0\n   */\n  startTime?: number;\n}\n\nexport const registerMseDash = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  onDestroy: (destroy: () => void) => void,\n  { autoPlay = false, startTime = 0 }: DashOptions = {},\n): Promise<void> => {\n  if (__VUEPRESS_SSR__) return;\n\n  if (isDashjsInstalled) {\n    const { default: dashjs } = await import(\n      /* webpackChunkName: \"dashjs\" */ \"dashjs\"\n    );\n\n    if (dashjs.supportsMediaSource()) {\n      // oxlint-disable-next-line new-cap\n      const dashPlayer = dashjs.MediaPlayer().create();\n\n      dashPlayer.initialize(mediaElement, src, autoPlay, startTime);\n\n      onDestroy(() => {\n        dashPlayer.destroy();\n      });\n    }\n  }\n};\n\nexport const registerMseFlv = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  onDestroy: (destroy: () => void) => void,\n): Promise<void> => {\n  if (__VUEPRESS_SSR__) return;\n\n  if (isMpegtsJsInstalled) {\n    const { default: mpegts } = await import(\n      /* webpackChunkName: \"mpegts.js\" */ \"mpegts.js/dist/mpegts.js\"\n    );\n\n    if (mpegts.isSupported()) {\n      const flvPlayer = mpegts.createPlayer({\n        type: \"flv\",\n        url: src,\n      });\n\n      flvPlayer.attachMediaElement(mediaElement);\n      flvPlayer.load();\n\n      onDestroy(() => {\n        flvPlayer.destroy();\n      });\n    }\n  }\n};\n\nexport const registerMseHls = async (\n  mediaElement: HTMLMediaElement,\n  src: string,\n  onDestroy: (destroy: () => void) => void,\n): Promise<void> => {\n  if (__VUEPRESS_SSR__) return;\n\n  if (\n    mediaElement.canPlayType(\"application/x-mpegURL\") ||\n    mediaElement.canPlayType(\"application/vnd.apple.mpegURL\")\n  ) {\n    mediaElement.src = src;\n  } else if (isHlsJsInstalled) {\n    const { default: HLS } = await import(\n      /* webpackChunkName: \"hls.js\" */ \"hls.js/dist/hls.min.js\"\n    );\n\n    if (HLS.isSupported()) {\n      const hlsInstance = new HLS();\n\n      hlsInstance.attachMedia(mediaElement);\n      hlsInstance.on(HLS.Events.MEDIA_ATTACHED, () => {\n        hlsInstance.loadSource(src);\n      });\n\n      onDestroy(() => {\n        hlsInstance.destroy();\n      });\n    }\n  }\n};\n","import { LoadingIcon, keys } from \"@vuepress/helper/client\";\nimport type Artplayer from \"artplayer\";\nimport type { Option as ArtPlayerInitOptions } from \"artplayer\";\nimport type { PropType, VNode } from \"vue\";\nimport { camelize, defineComponent, h, onMounted, onUnmounted, ref } from \"vue\";\nimport { useLang } from \"vuepress/client\";\n\nimport type { ArtPlayerOptions } from \"../../shared/index.js\";\nimport { useSize } from \"../composables/index.js\";\nimport { getLink } from \"../utils/getLink.js\";\nimport {\n  SUPPORTED_VIDEO_TYPES,\n  getTypeByUrl,\n  registerMseDash,\n  registerMseFlv,\n  registerMseHls,\n} from \"../utils/registerMse.js\";\n\nimport \"../styles/art-player.scss\";\n\nconst BOOLEAN_TRUE_ATTRS = [\n  \"no-fullscreen\",\n  \"no-hotkey\",\n  \"no-playback-rate\",\n  \"no-setting\",\n  \"no-mutex\",\n  \"no-plays-inline\",\n] as const;\n\nconst BOOLEAN_FALSE_ATTRS = [\n  \"airplay\",\n  \"autoplay\",\n  \"aspect-ratio\",\n  \"auto-mini\",\n  \"auto-size\",\n  \"auto-orientation\",\n  \"auto-playback\",\n  \"fast-forward\",\n  \"flip\",\n  \"fullscreen-web\",\n  \"lock\",\n  \"loop\",\n  \"is-live\",\n  \"muted\",\n  \"mini-progress-bar\",\n  \"pip\",\n  \"screenshot\",\n  \"subtitle-offset\",\n] as const;\n\n// Note: This should be updated with https://github.com/zhw2590582/ArtPlayer/blob/master/packages/artplayer/src/i18n/index.js\nconst SUPPORTED_LANG_NAME = new Set([\n  \"en\",\n  \"pl\",\n  \"cs\",\n  \"es\",\n  \"fa\",\n  \"fr\",\n  \"id\",\n  \"ru\",\n  \"tr\",\n]);\nconst SUPPORTED_LANG_CODE = new Set([\"zh-cn\", \"zh-tw\"]);\n\ntype KebabCaseToCamelCase<\n  Str extends string,\n  Cap extends boolean = false,\n> = Str extends `${infer Head}-${infer Tail}`\n  ? `${Cap extends true ? Capitalize<Head> : Head}${KebabCaseToCamelCase<\n      Tail,\n      true\n    >}`\n  : Cap extends true\n    ? Capitalize<Str>\n    : Str;\n\ntype ArtPlayerBooleanOptionKey =\n  | (typeof BOOLEAN_TRUE_ATTRS extends readonly (infer BooleanKey extends\n      string)[]\n      ? BooleanKey extends `no-${infer Key}`\n        ? KebabCaseToCamelCase<Key>\n        : never\n      : never)\n  | (typeof BOOLEAN_FALSE_ATTRS extends readonly (infer BooleanKey extends\n      string)[]\n      ? KebabCaseToCamelCase<BooleanKey>\n      : never);\n\ndeclare const ART_PLAYER_OPTIONS: ArtPlayerOptions;\n\nconst getLang = (lang: string): string => {\n  const langCode = lang.toLowerCase();\n  const [langName] = langCode.split(\"-\");\n\n  return SUPPORTED_LANG_CODE.has(langCode)\n    ? langCode\n    : SUPPORTED_LANG_NAME.has(langName)\n      ? langName\n      : langName === \"zh\"\n        ? \"zh-cn\"\n        : \"en\";\n};\n\nexport default defineComponent({\n  name: \"ArtPlayer\",\n\n  inheritAttrs: false,\n\n  props: {\n    /**\n     * Video Source URL\n     *\n     * 视频源文件地址\n     */\n    src: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Video Type\n     *\n     * 视频类型\n     */\n    type: String,\n\n    /**\n     * Video poster\n     *\n     * 视频封面\n     */\n    poster: String,\n\n    /**\n     * Video title\n     *\n     * 视频标题\n     */\n    title: String,\n\n    /**\n     * Component width\n     *\n     * 组件宽度\n     */\n    width: {\n      type: [String, Number],\n      default: \"100%\",\n    },\n\n    /**\n     * Component height\n     *\n     * 组件高度\n     */\n    height: [String, Number],\n\n    /**\n     * Component width / height ratio\n     *\n     * 组件长宽比\n     */\n    ratio: {\n      type: [String, Number],\n      default: 16 / 9,\n    },\n\n    /**\n     * ArtPlayer config\n     *\n     * ArtPlayer 配置\n     */\n    config: Object as PropType<Omit<ArtPlayerOptions, \"container\">>,\n\n    /**\n     * Customize Artplayer\n     *\n     * 对 Artplayer 进行自定义\n     */\n    customPlayer: Function as PropType<\n      (\n        player: Artplayer,\n      ) => Artplayer | void | Promise<Artplayer> | Promise<void>\n    >,\n  },\n\n  setup(props, { attrs }) {\n    const lang = useLang();\n    const { el, width, height, resize } = useSize<HTMLDivElement>(props, 0);\n\n    const loaded = ref(false);\n    let artPlayerInstance: Artplayer | null = null;\n\n    const getInitOptions = (): ArtPlayerInitOptions => {\n      const initOptions: ArtPlayerInitOptions = {\n        theme: \"#3eaf7c\",\n        ...ART_PLAYER_OPTIONS,\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n        container: el.value!,\n        poster: props.poster ?? \"\",\n        url: getLink(props.src),\n        type: props.type ?? getTypeByUrl(props.src),\n        lang: getLang(lang.value),\n        ...props.config,\n        // This option must be set false to avoid problems\n        useSSR: false,\n      };\n\n      const attrsKeys = keys(attrs);\n\n      BOOLEAN_TRUE_ATTRS.forEach((config) => {\n        if (attrsKeys.includes(config))\n          initOptions[\n            camelize(config.replace(/^no-/, \"\")) as ArtPlayerBooleanOptionKey\n          ] = false;\n      });\n      BOOLEAN_FALSE_ATTRS.forEach((config) => {\n        if (attrsKeys.includes(config))\n          initOptions[camelize(config) as ArtPlayerBooleanOptionKey] = true;\n      });\n\n      // Auto config mse\n      if (initOptions.type) {\n        const customType = (initOptions.customType ??= {});\n\n        if (SUPPORTED_VIDEO_TYPES.includes(initOptions.type.toLowerCase()))\n          switch (initOptions.type.toLowerCase()) {\n            case \"m3u8\":\n            case \"hls\": {\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer,\n              ): Promise<void> =>\n                registerMseHls(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n            }\n\n            case \"flv\":\n            case \"ts\": {\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer,\n              ): Promise<void> =>\n                registerMseFlv(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n            }\n\n            case \"mpd\":\n            case \"dash\": {\n              customType[initOptions.type] ??= (\n                video: HTMLVideoElement,\n                src: string,\n                player: Artplayer,\n              ): Promise<void> =>\n                registerMseDash(video, src, (destroy) => {\n                  player.on(\"destroy\", destroy);\n                });\n              break;\n            }\n\n            default:\n          }\n        else {\n          // eslint-disable-next-line no-console\n          console.warn(\n            `[components]: ArtPlayer does not support current file type ${initOptions.type}!`,\n          );\n        }\n      }\n\n      return initOptions;\n    };\n\n    onMounted(async () => {\n      if (__VUEPRESS_SSR__) return;\n\n      const { default: Artplayer } = await import(\n        /* webpackChunkName: \"artplayer\" */ \"artplayer\"\n      );\n      const player = new Artplayer(getInitOptions());\n\n      artPlayerInstance = (await props.customPlayer?.(player)) ?? player;\n      loaded.value = true;\n      resize();\n    });\n\n    onUnmounted(() => {\n      artPlayerInstance?.destroy();\n    });\n\n    return (): (VNode | null)[] => [\n      h(\"div\", {\n        ref: el,\n        class: \"vp-artplayer\",\n        style: {\n          width: width.value,\n          height: height.value,\n        },\n      }),\n      loaded.value ? null : h(LoadingIcon),\n    ];\n  },\n});\n"],"names":["SUPPORTED_VIDEO_TYPES","isDashjsInstalled","isHlsJsInstalled","isMpegtsJsInstalled","getTypeByUrl","url","registerMseDash","mediaElement","src","onDestroy","autoPlay","startTime","dashjs","dashPlayer","registerMseFlv","mpegts","flvPlayer","registerMseHls","HLS","hlsInstance","BOOLEAN_TRUE_ATTRS","BOOLEAN_FALSE_ATTRS","SUPPORTED_LANG_NAME","SUPPORTED_LANG_CODE","getLang","lang","langCode","langName","ArtPlayer","defineComponent","props","attrs","useLang","el","width","height","resize","useSize","loaded","ref","artPlayerInstance","getInitOptions","initOptions","getLink","attrsKeys","keys","config","camelize","customType","video","player","destroy","onMounted","Artplayer","onUnmounted","h","LoadingIcon"],"mappings":"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"}